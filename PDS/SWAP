*          DATA SET CBT1083    AT LEVEL 004 AS OF 05/28/80
SWAP     TITLE 'S W A P - System Workload Analysis Pgm - Version 4.5'   00001
*********************************************************************** 00002
*                                                                     * 00003
*                              S W A P                                * 00004
*                                                                     * 00005
*                 System  Workload Analysis Program                   * 00006
*                                                                     * 00007
*     SWAP enables a TSO user to get a brief look at what the         * 00008
*     system is doing. Various system and SRM values are displayed    * 00009
*     for each ASID currently executing.                              * 00010
*                                                                     * 00011
*     SWAP may be executed as a CALLed program or as a CP. Various    * 00012
*     subcommands are available to specify what information should    * 00013
*     be displayed.                                                   * 00014
*                                                                     * 00015
*     If SWAP is to be used in conjunction with SPY via the 'L'       * 00016
*     subcommand then SWAP must be APF-authorized and its name        * 00017
*     should go in the IKJEFTE2 and IKJEFTE8 lists. If SWAP is        * 00018
*     merely being used by itself APF authorization is unnecessary.   * 00019
*                                                                     * 00020
*                                                                     * 00021
*  Command         Description                                        * 00022
*                                                                     * 00023
*     A     Display started tasks,batch jobs and TSO                  * 00024
*     B     Display batch and started task jobs only                  * 00025
*     E     Exit from SWAP                                            * 00026
*     Fxxx  Display only those jobs whose name begins with 'xxx'.     * 00027
*           SWAP will continue in this mode until 'F' is entered.     * 00028
*     G     This mode will display general address space information. * 00029
*           (As opposed to 'S' mode.)                                 * 00030
*     I     This mode will display only those memories which are      * 00031
*           either swapped in and runngin or swapped out but ready    * 00032
*           to run.                                                   * 00033
*     L     XCTL to 'SPY' operator console program.                   * 00034
*     O     This mode will display all active memories in the system, * 00035
*           regardless of location.                                   * 00036
*     S     This mode will display SRM information. (As opposed to    * 00037
*           'G' mode.)                                                * 00038
*     T     Display TSO users only                                    * 00039
*     Dxx   set 'wait mode' delay time to 'xx' tenths of a second.    * 00040
*     Wxx   Enter automatic refresh mode. SWAP will automatically     * 00041
*           refresh and update the screen every so often for 'xx'     * 00042
*           seconds. If 'xx' is omitted, a default of 30 seconds is   * 00043
*           Assumed. If 'xx' = 0, the timer will count UP instead of  * 00044
*           down until 'PA1' is pressed.                              * 00045
*     ?     Display this list of help for SWAP commands               * 00046
*                                                                     * 00047
*  Glossary of terms for output display:                              * 00048
*                                                                     * 00049
*    HH:MM:SS  Transaction time                                       * 00050
*    R         Reason code for swap out (from OUCBEFL).               * 00051
*              The following are the reason codes displayed:          * 00052
*                    not swapped - in core                            * 00053
*                O   Swap code 1 : Terminal output wait               * 00054
*                I   Swap code 2 : Terminal input wait                * 00055
*                W   Swap code 3 : Long wait                          * 00056
*                A   Swap code 4 : Auxiliary storage shortage         * 00057
*                R   Swap code 5 : Real storage shortage              * 00058
*                V   Swap code 6 : MS0 detected wait                  * 00059
*                S   SWap code 7 : REQSWAP SYSEVENT issued            * 00060
*                E   SWap code 8 : ENQHOLD exchg by swap analysis     * 00061
*                X   Swap code 9 : Exchg recommended by swap analysis * 00062
*                $   Swap code a : Unilateral swapout                 * 00063
*                ?               : probable error or SRM modification * 00064
*    L         Current location of this memory:                       * 00065
*                I  Swapped in and eligible to run.                   * 00066
*                O  Swapped out but ready to run.                     * 00067
*                W  Swapped out and not ready to run.                 * 00068
*                $  Swapped in and V=R or non-swappable status.       * 00069
*                ?  Transitioning between states.                     * 00070
*                L  Logically swapped.                                * 00071
*    Mem       Current amount of memory allocated to this memory.     * 00072
*    WSS       SRM's view of the working set size for this memory.    * 00073
*    DP        Dispatching priority of memory (in hex).               * 00074
*    DQ        Relative position of memory on dispatching queue.      * 00075
*    PG        Performance group                                      * 00076
*    p         Performance group period                               * 00077
*    Dm        Domain                                                 * 00078
*    RM        Resource manager recommendation                        * 00079
*    WR        Work load manager recommendation                       * 00080
*    SU/S      Service rate (S.U.'s per second)                       * 00081
*    S.U.      Service units (in interval if mode=S )                 * 00082
*    I/O       EXCP's in interval (max=65K)                           * 00083
*    ASID      Address space ID (hex)                                 * 00084
*    CPU       Task CPU time                                          * 00085
*    TCPU      The total CPU time used by this memory (task+SRB).     * 00086
*    TRS       Service accumulated in the transaction.                * 00087
*    SC        Number of times the memory has been swapped            * 00088
*    MSL       MOUNT/START/LOGON initiated task                       * 00089
*    TCB       Number of active TCBs                                  * 00090
*    Procname  Procstepname for this step                             * 00091
*    Stepname  Stepname                                               * 00092
*    TSLS      Time since last swap action in seconds                 * 00093
*                                                                     * 00094
*    SWAP requires SYS1.AMODGEN as a MACLIB                           * 00095
*                                                                     * 00096
*    Registers used:                                                  * 00097
*        R1 - buffer address         R6 - ptr to OUCB                 * 00098
*        R2 - ptr to ASVT entry      R7 - R11  working regs           * 00099
*        R3 - count of ASCBs         R12 - Base register              * 00100
*        R4 - ptr to OUXB                                             * 00101
*        R5 - ptr to ASCB                                             * 00102
*                                                                     * 00103
*                                                                     * 00104
*                                                                     * 00113
*********************************************************************** 00114
         SPACE 4                                                        00115
R0       EQU   0                                                        00116
R1       EQU   1                                                        00117
R2       EQU   2                                                        00118
R3       EQU   3                                                        00119
R4       EQU   4                                                        00120
R5       EQU   5                                                        00121
R6       EQU   6                                                        00122
R7       EQU   7                                                        00123
R8       EQU   8                                                        00124
R9       EQU   9                                                        00125
R10      EQU   10                                                       00126
R11      EQU   11                                                       00127
R12      EQU   12                                                       00128
R13      EQU   13                                                       00129
R14      EQU   14                                                       00130
R15      EQU   15                                                       00131
         EJECT                                                          00132
SWAP     CSECT                                                          00133
         B     100(R15)           branch around save areas              00134
         DC    CL9'SWAP'          identifier                            00135
         DC    CL9'&SYSDATE'                                            00136
         DC    CL6'&SYSTIME'                                            00137
SAVE     DC    18F'0'             save area                             00138
         STM   R14,R12,12(R13)    save registers                        00139
         LR    R12,R15            R12 = addr of entry point             00140
         USING SWAP,R12           addresability to CSECT                00141
         LA    R11,SAVE           R11 = addr of our save area           00142
         ST    R13,SAVE+4         save pointer to callers save area     00143
         ST    R11,8(R13)         save ptr to our save area in caller's 00144
         LR    R13,R11            R13 = addr of our save area           00145
         EJECT                                                          00146
         BAL   R14,INITSCAN       initialize IKJSCAN parmlist           00147
         LA    3,STAXLIST                                               00148
         STAX  ATTNEXIT,MF=(E,(3)) attn exit trap                       00149
         GTSIZE ,                 get terminal size                     00150
         LTR   R0,R0              is it a hardcopy?                     00151
         BZ    HARDCOPY           yes; branch                           00152
         LR    R2,R0              R2 = number of lines per screen       00153
         SH    R2,=H'2'           R2 = R2 - 2                           00154
         MH    R2,=H'81'          R2 = number of bytes in screen bufr   00155
         LA    R3,BUFFER          R3 = addr of start of buffer          00156
         LA    R2,0(R2,R3)        R2 = addr of end of buffer            00157
         ST    R2,ADBUF           save R2                               00158
         STFSMODE ON,INITIAL=YES  turn on full screen mode for VTAM     00159
         B     BOTHTYPE                                                 00160
HARDCOPY STSIZE SIZE=80           set line size to 80                   00161
         MVI   CRTFLAG,X'00'      we are using a hardcopy               00162
         MVC   CLR(26),BLANKS     zap out cntrl chars                   00163
         MVC   CMDCTRL1(2),BLANKS                                       00164
BOTHTYPE MVC   HEADINGA(80),HEADING2   load general heading initially.  00165
*********************************************************************** 00166
*                                                                     * 00167
*                        Locate CVT and ASVT pointers                 * 00168
*                                                                     * 00169
*********************************************************************** 00170
FINDCVT  L     R2,16              CVT pointer                           00171
         USING CVT,R2                                                   00172
         L     R2,CVTASVT         ASVT pointer                          00173
         DROP  R2                                                       00174
         USING ASVT,R2                                                  00175
         L     R3,ASVTMAXU        maximum number of entries             00176
         LA    R2,ASVTFRST        first entry minus 4                   00177
         ST    R2,FRSTASVT        save it for later                     00178
         LA    R1,BUFFER          load address of output buffer.        00179
         ST    R2,ASCBADDR        save ASCB address                     00180
         CLC   JOBMASK(8),BLANKS  is the jobmask blank?                 00181
         BNE   ASCBLOOP           no, so don't set page to 0            00182
         MVI   PAGE,C'0'          reset page to page 0                  00183
         EJECT                                                          00184
*********************************************************************** 00185
*                                                                     * 00186
*            Major Loop (through all ASCB's)                          * 00187
*                                                                     * 00188
*********************************************************************** 00189
ASCBLOOP L     R2,ASCBADDR        R2 = addr of last ASCB entry          00190
         LA    R2,4(R2)           increment to next ASCB entry          00191
         ST    R2,ASCBADDR        save ASCB addr                        00192
         ICM   R5,B'1111',0(R2)   ASCB pointer                          00193
         USING ASCB,R5                                                  00194
         BM    NOGOOD             branch if bad ptr                     00195
         TM    102(R5),X'04'      test for swapped out                  00196
INOROUT  BC    0,NOGOOD           branch if out and not ready to run    00197
         L     R6,ASCBOUCB        OUCB pointer                          00198
         USING OUCB,R6                                                  00199
         L     R4,ASCBOUXB        OUXB pointer                          00200
         USING OUXB,R4                                                  00201
         TM    OUCBYFL,OUCBLOG    logon created user?                   00202
TSOORNO  BC    1,NOGOOD           branch if batch only                  00203
BATCHORN BC    0,NOGOOD           branch if TSO only                    00204
         MVI   LINE+2,C' '        clear output line to blanks.          00205
         MVC   LINE+3(77),LINE+2                                        00206
*********************************************************************** 00207
*                                                                     * 00208
*                              Jobname                                * 00209
*                                                                     * 00210
*********************************************************************** 00211
         MVC   JOB(8),START       initialize 'starting' jobname         00212
         ICM   R7,B'1111',ASCBJBNI jobname pointer                      00213
         BZ    NOTJOB             jobname not available                 00214
         MVC   JOB,0(R7)          move in jobname                       00215
         B     CONT1                                                    00216
NOTJOB   ICM   R7,B'1111',ASCBJBNS S/M/L pointer                        00217
         BZ    CONT1              S/M/L not available                   00218
         MVC   JOB,0(R7)          move in jobname for S/M/L             00219
CONT1    CLC   JOBMASK(8),BLANKS  is the job mask all blanks?           00220
         BE    CONT1A             yes, so go on                         00221
         LA    R8,JOBMASK         R8 = addr of jobmask                  00222
         LA    R7,JOBMASK+7       R7 = addr of last char in mask        00223
MASKLOOP CLI   0(R8),C' '         is the char a blank?                  00224
         BE    GOTLEN             yes                                   00225
         CR    R8,R7              is R8 = R7?                           00226
         BE    GOTLEN             yes - end of mask                     00227
         LA    R8,1(R8)           point to next char                    00228
         B     MASKLOOP           check next char                       00229
GOTLEN   LA    R7,JOBMASK+1       R7 = addr of first char in mask + 1   00230
         SR    R8,R7              R8 = length of mask - 1               00231
         EX    R8,VARCLC1         is the job mask = jobname?            00232
         BNE   NOGOOD             no, so flush this ASCB                00233
*********************************************************************** 00234
*                                                                     * 00235
*                             Swap count                              * 00236
*                                                                     * 00237
*********************************************************************** 00238
CONT1A   LH    R7,OUCBSWC         R7 = swap count                       00239
         CVD   R7,WORK            convert it to decimal.                00240
         MVO   WORK,WORK                                                00241
         MVI   WORK+7,X'0C'                                             00242
         MVC   $UCBSWC(2),PTRN1+5                                       00243
         ED    $UCBSWC-1(3),WORK+6                                      00244
*********************************************************************** 00245
*                                                                     * 00246
*                          Swap Reason code - OUCBSRC                 * 00247
*                                                                     * 00248
*********************************************************************** 00249
SWAPCODE TM    OUCBQFL,OUCBOUT    are we swapped out?                   00250
         BZ    FORGET             no, swap code means nothing           00251
         CLI   OUCBSRC,X'0A'      check for valid swap reason           00252
         BH    BADCODE            no.                                   00253
         CLI   OUCBSRC,X'00'                                            00254
         BE    BADCODE            no.                                   00255
         SR    R8,R8                                                    00256
         IC    R8,OUCBSRC         use code number as offset into table  00257
         SH    R8,=H'1'           decrease by 1                         00258
         LA    R7,CODETABL                                              00259
         LA    R7,0(R8,R7)        load addr of correct alpha code       00260
         MVC   STATUS(1),0(R7)    move code to output                   00261
         B     FORGET                                                   00262
BADCODE  MVI   STATUS,C'?'        error in code or program logic        00263
*********************************************************************** 00264
*                                                                     * 00265
*                    Address Space Queue Location                     * 00266
*                                                                     * 00267
*********************************************************************** 00268
FORGET   MVI   LOC,C'I'           assume address space on 'in' queue    00269
         MVI   LINE+1,X'E8'       attr byte - protected, hi intensity   00270
         TM    OUCBSFL,OUCBNSW    address space - non-swap              00271
*        BZ    LOGSQ              NO                                    00272
         BZ    WAITQ              NO                                    00272
         MVI   LOC,C'$'           MOVE IN NON-SWAP INDICATION.          00273
         B     DONE                                                     00274
*LOGSQ    TM    OUCBQFL,OUCBLSW    'LOGICAL SWAP' QUEUE                 00275
*        BZ    WAITQ              NO                                    00276
*        MVI   LOC,C'L'           'LOGICAL SWAP' QUEUE INDICATION       00277
*        MVI   LINE+1,X'60'       ATTR BYTE - LOW INTENSITY             00278
*        B     DONE                                                     00279
WAITQ    TM    OUCBQFL,OUCBOFF    'WAIT' QUEUE                          00280
         BZ    OUTQ               NO                                    00281
         MVI   LOC,C'W'           'WAIT' QUEUE INDICATION               00282
         MVI   LINE+1,X'60'       ATTR BYTE - LOW INTENSITY             00283
         B     DONE                                                     00284
OUTQ     TM    OUCBQFL,OUCBOUT    'OUT' QUEUE                           00285
         BZ    TRANS              NO                                    00286
         MVI   LOC,C'O'           'OUT' QUEUE INDICATION                00287
         MVI   LINE+1,X'60'       ATTR BYTE - LOW INTENSITY             00288
         B     DONE                                                     00289
TRANS    TM    OUCBQFL,OUCBGOO+OUCBGOI+OUCBGOB    TRANSITIONING' STATUS 00290
         BZ    DONE               NO                                    00291
         MVI   LOC,C'?'           'transitioning' indication            00292
*********************************************************************** 00293
*                                                                     * 00294
*                    Total CPU Time (task + SRB                       * 00295
*                                                                     * 00296
*********************************************************************** 00297
DONE     LM    R8,R9,ASCBEJST     EJST (CPU time - task type)           00298
         SRDL  R8,12              convert to microsec                   00299
         LM    R10,R11,ASCBSRBT   srb time                              00300
         SRDL  R10,12             convert to microsec                   00301
         AR    R9,R11             total (task + SRB) CPU time           00302
         BNO   NOOVFLO            branch if no overflow.                00303
         A     R8,=F'1'           otherwise add one to high order.      00304
NOOVFLO  AR    R8,R10             high order.                           00305
         D     R8,=F'100000'      for divide.                           00306
         CVD   R9,WORK            convert to decimal.                   00307
         MVC   TCPU(6),PTRN2                                            00308
         ED    TCPU-1(7),WORK+5                                         00309
*********************************************************************** 00310
*                                                                     * 00311
*                 Frames Allocated to address space                   * 00312
*                                                                     * 00313
*********************************************************************** 00314
         LH    R7,ASCBFMCT        allocated page frame count            00315
         CVD   R7,WORK                                                  00316
         MVC   MEM(3),PTRN1+4                                           00317
         ED    MEM-1(4),WORK+6                                          00318
         EJECT                                                          00319
*********************************************************************** 00320
*                                                                     * 00321
*     'General' or 'S.R.M.' Mode?                                     * 00322
*                                                                     * 00323
*********************************************************************** 00324
         CLI   SRMSW,X'00'                                              00325
         BE    GENERAL                                                  00326
*********************************************************************** 00327
*  SRM Mode:                                                          * 00328
*********************************************************************** 00329
*                                                                     * 00330
*                     Working Set size at swapin                      * 00331
*                                                                     * 00332
*********************************************************************** 00333
         LH    R7,OUCBWSS         swapin frame count                    00334
         CVD   R7,WORK                                                  00335
         MVC   $UCBWSS(3),PTRN1+4                                       00336
         ED    $UCBWSS-1(4),WORK+6                                      00337
*********************************************************************** 00338
*                                                                     * 00339
*                        Dispatching priority                         * 00340
*                                                                     * 00341
*********************************************************************** 00342
         XR    R7,R7              R7 = 0                                00343
         IC    R7,ASCBDP          R7 = dispatching priority             00344
         SRL   R7,4               convert first hex character           00345
         IC    R8,HEX(R7)                                               00346
         STC   R8,DP                                                    00347
         IC    R7,ASCBDP          R7 = dispatching priority             00348
         N     R7,=F'15'          convert second hex character          00349
         IC    R8,HEX(R7)                                               00350
         STC   R8,DP+1                                                  00351
*********************************************************************** 00352
*                                                                     * 00353
*                   Position on Dispatching queue                     * 00354
*                                                                     * 00355
*********************************************************************** 00356
         CLI   LOC,C'O'           memory swapped out ?                  00357
         BE    NOPOS              if yes, forget about position.        00358
         CLI   LOC,C'W'           wait status ?                         00359
         BE    NOPOS              if yes, forget about position.        00360
         LH    R7,ASCBSEQN        load dp queue position.               00361
         CVD   R7,WORK            prepare for conversion to EBCDIC.     00362
         UNPK  DQ,WORK+6(2)       convert to decimal.                   00363
         OI    DQ+1,X'F0'                                               00364
*********************************************************************** 00365
*                                                                     * 00366
*                  Resource Manager Recommendation                    * 00367
*                                                                     * 00368
*********************************************************************** 00369
NOPOS    L     R7,OUCBCMRV        composite WLM recommendation value    00370
         LTR   R7,R7              hi-order bit is on ?                  00371
         BNM   RMROK              yes, WMR invalid                      00372
         MVC   $UCBWMR,=C'**'     'not avail' indication                00373
         MVI   $UCBWMS+4,C'-'     blank out the service counter.        00374
         B     CONT3                                                    00375
RMROK    SRL   R7,8               divide by 256                         00376
         CVD   R7,WORK            convert to decimal .                  00377
         UNPK  $UCBRMR,WORK+6(2)                                        00378
         OI    $UCBRMR+1,X'F0'                                          00379
         CP    WORK+6(2),=PL2'0'  RMR greater than 99 ?                 00380
         BNE   CONT3              yes, double zero field.               00381
         MVI   $UCBRMR,C' '       WMR less than 1.                      00382
*********************************************************************** 00383
*                                                                     * 00384
*                         Performance Group                           * 00385
*                                                                     * 00386
*********************************************************************** 00387
CONT3    XR    R7,R7              R7 = 0                                00388
         ICM   R7,3,OUCBNPG       R7 = performance group                00389
         CVD   R7,WORK            convert to decimal.                   00390
         UNPK  $UCBPGN,WORK+6(2)                                        00391
         OI    $UCBPGN+1,X'F0'                                          00392
*********************************************************************** 00393
*                                                                     * 00394
*                      Performance Group Period                       * 00395
*                                                                     * 00396
*********************************************************************** 00397
         XR    R7,R7              R7 = 0                                00398
         IC    R7,OUCBPGP         performance group period offset       00399
         SH    R7,=H'12'          - 12                                  00400
         SRL   R7,4               / 16                                  00401
         LA    R7,1(R7)                                                 00402
         STC   R7,$UCBPGP                                               00403
         OI    $UCBPGP,X'F0'                                            00404
*********************************************************************** 00405
*                                                                     * 00406
*                         Domain                                      * 00407
*                                                                     * 00408
*********************************************************************** 00409
         XR    R7,R7              R7 = 0                                00410
         IC    R7,OUCBDMN         R7 = domain                           00411
         CVD   R7,WORK            convert to decimal.                   00412
         UNPK  $UCBDOM,WORK+6(2)                                        00413
         OI    $UCBDOM+1,X'F0'                                          00414
*********************************************************************** 00415
*                                                                     * 00416
*                      WLM Recommendation value                       * 00417
*                                                                     * 00418
*********************************************************************** 00419
         L     R7,OUCBWMR         work load manager rec. value          00420
         LTR   R7,R7              hi-order bit is on ?                  00421
         BNM   WMROK              yes, WMR invalid                      00422
         MVC   $UCBWMR,=C'NA'     'not avail' indication                00423
         MVI   $UCBWMS+4,C'-'     blank out the service counter.        00424
         B     NORECOM                                                  00425
WMROK    SRL   R7,8               divide by 256                         00426
         CVD   R7,WORK            convert to decimal .                  00427
         UNPK  $UCBWMR,WORK+6(2)                                        00428
         OI    $UCBWMR+1,X'F0'                                          00429
         CP    WORK+6(2),=PL2'0'  WMR greater than 99 ?                 00430
         BNE   NORECOM            yes, double zero field.               00431
         MVI   $UCBWMR,C' '       WMR less than 1.                      00432
*********************************************************************** 00433
*                                                                     * 00434
*                      In-Storage Service Rate                        * 00435
*                                                                     * 00436
*********************************************************************** 00437
NORECOM  L     R10,16             R10 = addr of CVT                     00438
         USING CVT,R10                                                  00439
         L     R10,CVTOPCTP       R10 = addr of RMCT                    00440
         DROP  R10                                                      00441
         L     R10,X'7C'(R10)     R10 = current TOD                     00442
         S     R10,OUCBTMW        WLM interval start time               00443
         BP    PLUSRATE                                                 00444
         MVC   SERATE(3),BLANKS                                         00445
         B     NOSRV                                                    00446
PLUSRATE L     R8,OUCBWMS         interval service units                00447
         SRDL  R8,32              calculate sevice rate                 00448
         M     R8,=F'976'                                               00449
         DR    R8,R10                                                   00450
         CVD   R9,WORK            convert to decimal                    00451
         MVC   SERATE(3),PTRN1+4                                        00452
         ED    SERATE-1(4),WORK+6                                       00453
*********************************************************************** 00454
*                                                                     * 00455
*                   Interval Service Accumulation                     * 00456
*                                                                     * 00457
*********************************************************************** 00458
NOSRV    L     R7,OUCBWMS         service units - transaction           00459
         CVD   R7,WORK            convert to decimal.                   00460
         MVC   $UCBWMS(6),PTRN1+1                                       00461
         MVO   WORK,WORK                                                00462
         MVI   WORK+7,X'0C'                                             00463
         ED    $UCBWMS-1(7),WORK+4                                      00464
*********************************************************************** 00465
*                                                                     * 00466
*              I/O Count used for Recommendation value                * 00467
*                                                                     * 00468
*********************************************************************** 00469
         LH    R9,ASCBIOSM        R9 =  I/O service measure             00470
         LH    R10,OUXBIOS        R10 = WLM base I/O measurement        00471
         SLR   R9,10              I/O count for this in core interval   00472
         N     R9,=X'0000FFFF'    clear high order bytes                00473
         CVD   R9,WORK                                                  00474
         MVC   IOC(5),PTRN1+2                                           00475
         ED    IOC-1(6),WORK+5                                          00476
*********************************************************************** 00477
*                                                                     * 00478
*              TSLS - TIME SINCE Last swap (seconds)                  * 00479
*                                                                     * 00480
*********************************************************************** 00481
         L     R8,16              R8 = addr of CVT                      00482
         USING CVT,R8                                                   00483
         L     R8,CVTOPCTP        R8 = addr of RMCT                     00484
         DROP  R8                                                       00485
         L     R8,X'7C'(R8)       R8 = time-of-day                      00486
         S     R8,OUCBTMS         subtract time of last swap action     00487
         SRDL  R8,32              convert to HH.MM.SS                   00488
         D     R8,=F'1024'        convert to seconds                    00489
         CVD   R9,WORK                                                  00490
         MVC   TSLS(5),PTRN1+2                                          00491
         ED    TSLS-1(6),WORK+5                                         00492
*                                                                       00493
*                                                                       00494
         B     LINEDONE                                                 00495
         EJECT                                                          00496
*********************************************************************** 00497
*                                                                     * 00498
*                      Elapsed Transaction time                       * 00499
*                                                                     * 00500
*********************************************************************** 00501
GENERAL  L     R8,16              R8 = addr of CVT                      00502
         USING CVT,R8                                                   00503
         L     R8,CVTOPCTP        R8 = addr of RMCT                     00504
         DROP  R8                                                       00505
         L     R8,X'7C'(R8)       R8 = current TOD                      00506
         S     R8,OUCBTMO         subtract transaction start time       00507
         SRDL  R8,32              convert to HH.MM.SS                   00508
         D     R8,=F'1024'        convert to seconds                    00509
         ST    R9,TRANSSEC        store seconds for later               00510
         SR    R8,R8              get hours                             00511
         D     R8,=F'3600'                                              00512
         CVD   R9,PACK                                                  00513
         UNPK  HH,PACK+6(R2)                                            00514
         OI    HH+1,X'F0'                                               00515
         MVI   HH+2,C':'                                                00516
         SRDL  R8,32              get minutes                           00517
         D     R8,=F'60'                                                00518
         CVD   R9,PACK                                                  00519
         UNPK  MM(2),PACK+6(2)                                          00520
         OI    MM+1,X'F0'                                               00521
         MVI   MM+2,C':'          get seconds                           00522
         CVD   R8,PACK                                                  00523
         UNPK  SS(2),PACK+6(2)                                          00524
         OI    SS+1,X'F0'                                               00525
*********************************************************************** 00526
*                                                                     * 00527
*                          Address Space ID                           * 00528
*                                                                     * 00529
*********************************************************************** 00530
         L     R9,ASCBADDR        R9 = addr of entry in ASVT table      00531
         S     R9,FRSTASVT        minus addr of first entry             00532
         SRL   R9,2               divide by 4 = ASID                    00533
         LR    R7,R9              R7 = ASID                             00534
         SRL   R7,4               convert first hex character           00535
         IC    R8,HEX(R7)                                               00536
         STC   R8,ASID                                                  00537
         LR    R7,R9              R7 = ASID                             00538
         N     R7,=F'15'          convert second hex character          00539
         IC    R8,HEX(R7)                                               00540
         STC   R8,ASID+1                                                00541
*********************************************************************** 00542
*                                                                     * 00543
*                           Task CPU time                             * 00544
*                                                                     * 00545
*********************************************************************** 00546
         LM    R8,R9,ASCBEJST     EJST (CPU time - task type)           00547
         SRDL  R8,12              convert to microsec                   00548
         D     R8,=F'100000'      convert to seconds x 10-3             00549
         CVD   R9,WORK            convert to decimal.                   00550
         MVC   CPU(6),PTRN2                                             00551
         ED    CPU-1(7),WORK+5                                          00552
*********************************************************************** 00553
*                                                                     * 00554
*                            Stepname                                 * 00555
*                                                                     * 00556
*********************************************************************** 00557
         ICM   R7,B'1111',ASCBJBNI jobname pointer                      00558
         BZ    SML                jobname not available                 00559
         MVC   PROCSTEP(8),24(R7) move in procstepname                  00560
         MVC   STEPNAME,56(R7)    move in stepname                      00561
         B     CONT                                                     00562
SML      ICM   R7,B'1111',ASCBJBNS S/M/L pointer                        00563
         BZ    CONT               S/M/L not available                   00564
         CLI   JOB,C'*'           is this *MASTER* ?                    00565
         BE    TSO                yes, treat it like a userid           00566
         TM    OUCBYFL,OUCBSTT    is this a started task?               00567
         BNO   TSO                no, so use TSO stepname               00568
         B     CONT                                                     00569
TSO      MVC   STEPNAME,8(R7)     move in stepname for LOGON            00570
CONT     EQU    *                                                       00571
*********************************************************************** 00572
*                                                                     * 00573
*                    M/S/L                                            * 00574
*                                                                     * 00575
*********************************************************************** 00576
         TM    OUCBYFL,OUCBSTT    START created task?                   00577
         BZ    TEST2              no                                    00578
         MVI   MSL,C'S'                                                 00579
         B     CONT2                                                    00580
TEST2    TM    OUCBYFL,OUCBLOG    LOGON created task?                   00581
         BZ    TEST3              no                                    00582
         MVI   MSL,C'L'                                                 00583
         B     CONT2                                                    00584
TEST3    TM    OUCBYFL,OUCBMNT    MOUNT created task?                   00585
         BZ    CONT2              no                                    00586
         MVI   MSL,C'M'                                                 00587
*********************************************************************** 00588
*                                                                     * 00589
*                  # TCBs Active                                      * 00590
*                                                                     * 00591
*********************************************************************** 00592
CONT2    L     R7,ASCBTCBS         R7 = no. of active TCBs              00593
         CVD   R7,WORK                                                  00594
         UNPK  TCBA,WORK+7(1)                                           00595
         OI    TCBA,X'F0'                                               00596
*********************************************************************** 00597
*                                                                     * 00598
*                  Transaction Service Accumulation                   * 00599
*                                                                     * 00600
*********************************************************************** 00601
         TM    OUCBQFL,OUCBOUT    address space swapped in              00602
         BO    OUTRANS            yes                                   00603
         L     R7,OUXBTRS         accumulated service                   00604
         CVD   R7,WORK            convert to decimal.                   00605
         MVC   $UXBTRS(7),PTRN1                                         00606
         ED    $UXBTRS-1(8),WORK+4                                      00607
         B     LINEDONE                                                 00608
OUTRANS  MVC   $UXBTRS(7),BLANKS  OUXB not available                    00609
*                                                                       00610
*        Move Line to buffer                                            00611
*                                                                       00612
LINEDONE MVC   0(81,R1),LINE      move the line to the 3270 buffer.     00613
         LH    R7,SCRSIZE         increment 'TPUT' size                 00614
         LA    R7,81(R7)          add 81 to current buffer length       00615
         STH   R7,SCRSIZE         store away again                      00616
         LA    R1,81(R1)          R1 = addr of bottom of buffer         00617
         C     R1,ADBUF           have we reached the bottom?           00618
         BE    PUTIT              yes, go put this screen.              00619
NOGOOD   BCT   R3,ASCBLOOP        process next address space            00620
         DROP  R4,R5,R6                                                 00621
         EJECT                                                          00622
*********************************************************************** 00623
*                                                                     * 00624
*              Put the SWAP buffer to the 3270 screen                 * 00625
*                                                                     * 00626
*********************************************************************** 00627
PUTIT    CLC   JOBMASK(8),BLANKS  is the jobmask blank?                 00628
         BNE   CHKTYPE            no, so skip                           00629
         IC    R8,PAGE            load current page character           00630
         LA    R8,1(R8)           add one to it                         00631
         STC   R8,PAGE            store it back                         00632
         CLC   SCRSIZE(2),=H'0'   is the screen empty?                  00633
         BE    FINDCVT            yes - go do the screen over           00634
CHKTYPE  CLI   CRTFLAG,X'FF'      is this a CRT?                        00635
         BE    CRT1               yes                                   00636
         LA    R1,ERROR           R1 = addr of first line               00637
         LA    R0,79              R0 = length of heading                00638
         ICM   R1,8,EDITFLG       edit mode                             00639
         TPUT  (1),(0),R          write line                            00640
         LA    R1,HEADINGA+1      R1 = addr of first line               00641
         LA    R0,79              R0 = length of heading                00642
         ICM   R1,8,EDITFLG       edit mode                             00643
         TPUT  (1),(0),R          write line                            00644
         LH    R7,SCRSIZE         R7 = total screensize                 00645
         LA    R8,81              R8 = one line                         00646
         LA    R1,BUFFER+2        set pointer to first line             00647
         ICM   R1,8,EDITFLG       edit mode                             00648
         LA    R0,79              R0 length of output line              00649
NEXTL    LR    R2,R1              save R1 since TPUT zaps it            00650
         TPUT  (1),(0),R          print one line                        00651
         LA    R8,81(R8)          add 81 bytes                          00652
         CR    R7,R8              have we printed last line?            00653
         BL    CONTA              yes, continue                         00654
         LA    R1,81(R2)          nope, point to next line              00655
         LA    R0,79              load length                           00656
         ICM   R1,8,EDITFLG       edit mode                             00657
         B     NEXTL              print next line                       00658
CRT1     LA    R1,CLEAR           R1 = addr of buffer                   00659
         LA    R0,LENGTH          R0 = length of buffer                 00660
         AH    R0,SCRSIZE         R0 = full length of buffer            00661
         ICM   R1,8,FULLSCR       full screen mode                      00662
         TPUT  (1),(0),R          put screen                            00663
CONTA    MVC   ERROR(27),BLANKS   blank out error field                 00664
         CLI   WAITSW,X'FF'       are we in wait mode?                  00665
         BNE   GETCHAR            no, read from terminal                00666
*********************************************************************** 00667
*                                                                     * 00668
*                           'Wait' mode                               * 00669
*                                                                     * 00670
*********************************************************************** 00671
         STIMER WAIT,BINTVL=DELAY yes, wait 1 second                    00672
         L     R10,COUNTER        load counter                          00673
         BCTR  R10,0              counter = counter - 1                 00674
         ST    R10,COUNTER        store back                            00675
         CVD   R10,WORK           convert to decimal.                   00676
         MVC   SCRATCH(4),PATTERN move in edit pattern                  00677
         ED    SCRATCH(4),WORK+6  edit in time                          00678
         MVC   TIME(3),SCRATCH+1  move in time                          00679
         LTR   R10,R10            counter = 0 ?                         00680
         BNZ   CONTINUE           refresh if still counting             00681
         XI    WAITSW,X'FF'       counter up, do reads again            00682
         MVC   TIME(3),BLANKS     clear counter field                   00683
         B     CONTINUE           refresh one last time                 00684
*********************************************************************** 00685
*                                                                     * 00686
*                       Read Command from user                        * 00687
*                                                                     * 00688
*********************************************************************** 00689
GETCHAR  MVC   REPLY(33),BLANKS   blank out reply field                 00690
         TGET  REPLY,33           get 79 characters from terminal       00691
         CLI   REPLY,X'6E'        reshow code?                          00692
         BE    GETCHAR            yes; ignore it                        00693
         OC    REPLY(33),BLANKS   convert chars to upper case           00694
         XC    CBUF+2(2),CBUF+2   clear offset                          00695
         MVC   CSPLBLOK(24),CSPLSAVE  copy in CSPL blok                 00696
         XC    CSOABLOK(8),CSOABLOK                                     00697
         L     R2,SAVEJSCB        R2 = addr of JSCB                     00698
         USING IEZJSCB,R2                                               00699
*********************************************************************** 00700
*                                                                     * 00701
*     IKJSCAN is being called merely to allow the 'X' feature to      * 00702
*     function if desired. If SWAP is being used in conjunction       * 00703
*     with 'SPY', then SWAP must be APF authorized. Since 'X' will    * 00704
*     not work with authorized programs, we flip off the auth bit     * 00705
*     in the JSCB to fool it.                                         * 00706
*                                                                     * 00707
*********************************************************************** 00708
*        NI    JSCBOPTS,X'FF'-JSCBAUTH turn off auth to fool PCFSCAN    00709
         LA    R1,CSPLBLOK        R1 = addr of cmd scan parm list       00710
         L     R15,ADDRSCAN       R15 = addr of IKJSCAN                 00711
         BALR  R14,R15            invoke IKJSCAN                        00712
*        OI    JSCBOPTS,JSCBAUTH  turn APF bits back on                 00713
         DROP  R2                                                       00714
         LA    R1,CSOABLOK        R1 = addr of cmd scan output area     00715
         USING CSOA,R1                                                  00716
         TM    CSOAFLG,CSOANOC    is the buffer empty?                  00717
         BO    CONTINUE           yes; just go refresh                  00718
         DROP  R1                                                       00719
         SPACE 3                                                        00720
*********************************************************************** 00721
*                                                                     * 00722
*                       W  --  Enter wait mode                        * 00723
*                                                                     * 00724
*********************************************************************** 00725
WAITCHK  CLI   REPLY,C'W'         go into wait mode?                    00726
         BNE   CDELAY             no                                    00727
         XI    WAITSW,X'FF'       yes, toggle wait switch               00728
         LA    R2,30              set default value = 30                00729
         LA    R15,CONVBIN        branch to conversion rtn              00730
         BALR  R14,R15            EBCDIC to binary                      00731
         MVC   SCRATCH(4),PATTERN move in edit pattern                  00732
         ED    SCRATCH(4),WORK+6  edit in time left                     00733
         MVC   TIME(3),SCRATCH+1  move time left into place             00734
         ST    R2,COUNTER         store starting timer value            00735
         B     CONTINUE           all set - go display next page        00736
         SPACE 3                                                        00737
*********************************************************************** 00738
*                                                                     * 00739
*            D  --  Set timer delay in tenths of a second             * 00740
*                                                                     * 00741
*********************************************************************** 00742
CDELAY   CLI   REPLY,C'D'         are we changing the time delay?       00743
         BNE   ENDCHK             no, so continue                       00744
         LA    R2,10              set default value = 10 tenths second  00745
         LA    R15,CONVBIN        branch to conversion rtn              00746
         BALR  R14,R15            EBCDIC to binary                      00747
         MVC   SCRATCH(5),DPATTRN move in edit pattern                  00748
         ED    SCRATCH(5),WORK+6  edit in delay time                    00749
         MVC   PAUSE(3),SCRATCH+2 move time left into place             00750
         MH    R2,=H'10'          convert to 100ths of a second         00751
         ST    R2,DELAY           store wait delay value                00752
         B     CONTINUE           all set - go display next page        00753
         SPACE 3                                                        00754
*********************************************************************** 00755
*                                                                     * 00756
*                          E  --  End SWAP                            * 00757
*                                                                     * 00758
*********************************************************************** 00759
ENDCHK   CLI   REPLY,C'E'         termination requested ?               00760
         BE    STOP               all done                              00761
         SPACE 3                                                        00762
*********************************************************************** 00763
*                                                                     * 00764
*                   T  --  TSO Address spaces only                    * 00765
*                                                                     * 00766
*********************************************************************** 00767
TSOCHK   CLI   REPLY,C'T'         TSO only ?                            00768
         BNE   BATCHCHK           no                                    00769
         MVI   MODESW,X'FF'       indicate change of modes.             00770
         MVI   BATCHORN+1,X'80'   reset the branches                    00771
         MVI   TSOORNO+1,X'00'    only TSO memories.                    00772
         MVI   MODETBA,C'T'       set mode indicator                    00773
         B     CONTINUE                                                 00774
         SPACE 3                                                        00775
*********************************************************************** 00776
*                                                                     * 00777
*                  B  --  Batch Address spaces only                   * 00778
*                                                                     * 00779
*********************************************************************** 00780
BATCHCHK CLI   REPLY,C'B'         batch only ?                          00781
         BNE   BOTHCHK            no                                    00782
         MVI   MODESW,X'FF'       indicate change of modes.             00783
         MVI   TSOORNO+1,X'10'    reset the branches                    00784
         MVI   BATCHORN+1,X'00'   only batch (STC) memories.            00785
         MVI   MODETBA,C'B'       set mode indicator                    00786
         B     CONTINUE                                                 00787
         SPACE 3                                                        00788
*********************************************************************** 00789
*                                                                     * 00790
*             A  --  All Address Spaces (Batch and TSO)               * 00791
*                                                                     * 00792
*********************************************************************** 00793
BOTHCHK  CLI   REPLY,C'A'         batch and TSO?                        00794
         BNE   OUTCHK             no                                    00795
         MVI   MODESW,X'FF'       indicate change of modes.             00796
         MVI   TSOORNO+1,X'00'    yes, so NOP all the                   00797
         MVI   BATCHORN+1,X'00'   selection branches.                   00798
         MVI   MODETBA,C'A'       set mode indicator                    00799
         B     CONTINUE                                                 00800
         SPACE 3                                                        00801
*********************************************************************** 00802
*                                                                     * 00803
*        O  --  Address Spaces which are 'out' and not ready          * 00804
*                                                                     * 00805
*********************************************************************** 00806
OUTCHK   CLI   REPLY,C'O'         out mode ?                            00807
         BNE   INCHK              no                                    00808
         MVI   MODESW,X'FF'       indicate change of modes.             00809
         MVI   INOROUT+1,X'00'    nop the branch                        00810
         MVI   MODEIO,C'O'        set mode indicator                    00811
         B     CONTINUE                                                 00812
         SPACE 3                                                        00813
*********************************************************************** 00814
*                                                                     * 00815
*             I  --  Address Spaces which are swapped in              * 00816
*                                                                     * 00817
*********************************************************************** 00818
INCHK    CLI   REPLY,C'I'         in or ready mode ?                    00819
         BNE   FINDCHK            no                                    00820
         MVI   INOROUT+1,X'10'    branch                                00821
         MVI   MODESW,X'FF'       indicate mode switch.                 00822
         MVI   MODEIO,C'I'        set mode indicator                    00823
         B     CONTINUE                                                 00824
         SPACE 3                                                        00825
*********************************************************************** 00826
*                                                                     * 00827
*                F  --  Display only certain jobnames                 * 00828
*                                                                     * 00829
*********************************************************************** 00830
FINDCHK  CLI   REPLY,C'F'         should we set the jobmask?            00831
         BNE   SRMCHK             no                                    00832
         MVI   MODESW,X'FF'       indicate mode switch.                 00833
         MVC   JOBMASK(8),REPLY+1 move mask into place                  00834
         MVC   MASKNAME(8),JOBMASK move mask indicator into place       00835
         CLC   JOBMASK(8),BLANKS  is jobmask blank?                     00836
         BNE   CONTINUE           no, go on                             00837
         MVC   MASKNAME(8),=C'  Page 1'                                 00838
         B     CONTINUE                                                 00839
         SPACE 3                                                        00840
*********************************************************************** 00841
*                                                                     * 00842
*                      S  --  SRM display mode                        * 00843
*                                                                     * 00844
*********************************************************************** 00845
SRMCHK   CLI   REPLY,C'S'         SRM mode ?                            00846
         BNE   GENCHK             no                                    00847
         MVI   SRMSW,X'FF'        indicate SRM mode                     00848
         MVC   HEADINGA(80),HEADING1 move in SRM heading                00849
         MVC   MODEGS(7),=C'S.R.M. ' set mode indicator                 00850
         B     CONTINUE                                                 00851
         SPACE 3                                                        00852
*********************************************************************** 00853
*                                                                     * 00854
*                    G  --  General display mode                      * 00855
*                                                                     * 00856
*********************************************************************** 00857
GENCHK   CLI   REPLY,C'G'         general mode ?                        00858
         BNE   LINKSPY            no                                    00859
         MVI   SRMSW,X'00'        indicate general mode                 00860
         MVC   HEADINGA(80),HEADING2 move in general heading            00861
         MVC   MODEGS(7),=C'General' set mode indicator                 00862
         B     CONTINUE                                                 00863
         SPACE 3                                                        00864
*********************************************************************** 00865
*                                                                     * 00866
*                         L  --  Link to SPY                          * 00867
*                                                                     * 00868
*********************************************************************** 00869
LINKSPY  CLI   REPLY,C'L'         XCTL to SPY?                          00870
         BNE   NEEDHELP           no                                    00871
         L     R13,SAVE+4         callers save area pointer.            00872
         XCTL  (2,12),EP=OPCON    XCTL to SPY                           00873
         SPACE 3                                                        00874
*********************************************************************** 00875
*                                                                     * 00876
*               ?  --  Display help for SWAP commands                 * 00877
*                                                                     * 00878
*********************************************************************** 00879
NEEDHELP CLI   REPLY,C'?'         user needs help page displayed?       00880
         BNE   BADCMD                                                   00881
         L     R1,HLP1ADDR        R1 = addr of help                     00882
         LA    R0,HELPLEN1        R0 = length of help                   00883
         ICM   R1,8,FULLSCR       full screen mode                      00884
         TPUT  (1),(0),R          write help to screen                  00885
         TGET  REPLY,33           go get a command                      00886
         L     R1,HLP2ADDR        R1 = addr of help                     00887
         LA    R0,HELPLEN2        R0 = length of help                   00888
         ICM   R1,8,FULLSCR       full screen mode                      00889
         TPUT  (1),(0),R          write help to screen                  00890
         B     GETCHAR            go get a command                      00891
         SPACE 3                                                        00892
*********************************************************************** 00893
*                                                                     * 00894
*                     Blank or Invalid commands                       * 00895
*                                                                     * 00896
*********************************************************************** 00897
BADCMD   CLI   REPLY,C' '         was a blank just entered?             00898
         BE    CONTINUE                                                 00899
         MVC   ERROR(27),ERRMSG2  move in bad command msg               00900
CONTINUE MVC   SCRSIZE,=H'0'      reset screen size.                    00901
         LA    R1,BUFFER          ---+                                  00902
         LA    R6,BUFFER             :                                  00903
         ICM   R6,8,C' '             : move character long to fill      00904
         LA    R7,22*81              : screen buffer with blanks        00905
         LA    R8,BUFFER             :                                  00906
         SR    R9,R9                 :                                  00907
         MVCL  R6,R8              ---+                                  00908
         CLI   MODESW,X'FF'       change of modes ?                     00909
         BNE   MODEOK             branch if same mode.                  00910
         MVI   MODESW,X'00'       reset mode change.                    00911
         B     FINDCVT            start over from beginning.            00912
MODEOK   LTR   R3,R3              more memories to process ?            00913
         BNZ   NOGOOD             yes.                                  00914
         CLI   ATTNFLG,X'00'      was attn hit?                         00915
         BE    FINDCVT            no                                    00916
         MVI   ATTNFLG,X'00'      yes, reset flag                       00917
         MVC   TIME(3),BLANKS     blank out timer field                 00918
         MVI   WAITSW,X'00'       turn off wait flag                    00919
         LA    R3,0               R3 = 0                                00920
         ST    R3,COUNTER         set timer to 0                        00921
         B     FINDCVT            otherwise, start over from the top.   00922
STOP     CLI   CRTFLAG,X'00'      is this a CRT?                        00923
         BE    STOP1              no; don't clear                       00924
         LA    R1,CLR             R1 = addr of clear string             00925
         LA    R0,CLRLEN          R0 = length of clear string           00926
         ICM   R1,8,FULLSCR       full screen mode                      00927
         TPUT  (1),(0),R          clear the screen before we leave      00928
         STFSMODE OFF             turn off fullscreen mode              00929
STOP1    L     R13,SAVE+4                                               00930
         RETURN (14,12),RC=0                                            00931
VARCLC1  CLC   JOBMASK(0),JOB                                           00932
         EJECT                                                          00933
*********************************************************************** 00934
*                                                                     * 00935
*            Convert EBCDIC numbers from user into binary             * 00936
*                                                                     * 00937
*********************************************************************** 00938
CONVBIN  CVD   R2,WORK            convert to decimal.                   00939
         CLI   REPLY+1,C' '       did he enter a number?                00940
         BE    RTRN               no, use the default                   00941
         CLI   REPLY+1,C'0'       is the hex code < 'F0' ?              00942
         BL    BADCHAR            yes, error                            00943
         CLI   REPLY+1,C'9'       is the hex code > 'F9' ?              00944
         BH    BADCHAR            yes, error                            00945
         PACK  WORK(8),REPLY+1(1) pack EBCDIC (assume 1 digit)          00946
         CLI   REPLY+2,C' '       did he enter 2 digits?                00947
         BE    CVB                no, dont do the 2 digit pack          00948
         CLI   REPLY+2,C'0'       is the hex code < 'F0' ?              00949
         BL    BADCHAR            yes, error                            00950
         CLI   REPLY+2,C'9'       is the hex code > 'F9' ?              00951
         BH    BADCHAR            yes, error                            00952
         PACK  WORK(8),REPLY+1(2) pack again, with 2 digits this time   00953
CVB      CVB   R2,WORK            get binary                            00954
RTRN     BR    R14                return to mainline                    00955
BADCHAR  MVC   ERROR(27),ERRMSG1  numeric error                         00956
         B     RTRN                                                     00957
         EJECT                                                          00958
*********************************************************************** 00959
*                                                                     * 00960
*          Setup and Initialize Parameter list for IKJSCAN            * 00961
*                                                                     * 00962
*********************************************************************** 00963
INITSCAN STM   R15,R4,SAVE154     save regs                             00964
         L     R3,CVTPTR          R3 = addr of CVT                      00965
         L     R3,0(R3)           R3 = addr of addr of TCB              00966
         L     R3,4(R3)           R3 = addr of TCB                      00967
         USING TCB,R3                                                   00968
         ICM   R3,7,TCBJSCBB      R3 = addr of JSCB                     00969
         ST    R3,SAVEJSCB        save addr of JSCB                     00970
         DROP  R3                                                       00971
         USING IEZJSCB,R3                                               00972
         L     R4,JSCBPSCB        R4 = addr of PSCB                     00973
         DROP  R3                                                       00974
         USING PSCB,R4                                                  00975
         L     R3,PSCBUPT         R3 = addr of UPT                      00976
         ST    R3,SAVEUPT         save addr of UPT                      00977
         LA    R2,CSPLSAVE        R2 = addr of cmd scan parm list       00978
         USING CSPL,R2                                                  00979
         ST    R3,CSPLUPT         save UPT addr                         00980
         L     R3,PSCBRLGB        R3 = addr of relogon buffer           00981
         L     R3,256(R3)         R3 = addr of ECT                      00982
         ST    R3,CSPLECT         save ECT addr                         00983
         LA    R3,CPECB           R3 = addr of fake ECB for this CP     00984
         ST    R3,CSPLECB         save ECB addr                         00985
         LA    R3,FLAGWORD        R3 = addr of CSPL flag word           00986
         ST    R3,CSPLFLG         save flag addr                        00987
         LA    R3,CSOABLOK        R3 = addr of cmd scan output area     00988
         ST    R3,CSPLOA          save output area addr                 00989
         LA    R3,CBUF            R3 = addr of 'cmd buffer'             00990
         ST    R3,CSPLCBUF        save cbuf addr                        00991
         DROP  R2,R4                                                    00992
         LOAD  EP=IKJSCAN                                               00993
         ST    R0,ADDRSCAN                                              00994
         LM    R15,R4,SAVE154     restore regs 15 - 4                   00995
         BR    R14                                                      00996
         SPACE 2                                                        00997
         DS    0F                                                       00998
SAVE154  DS    6F                                                       00999
         SPACE 1                                                        01000
SAVEUPT  DS    F                   save addr of UPT                     01001
SAVEJSCB DS    F                   save addr of JSCB                    01002
CSPLBLOK DS    6F                  cmd scan parameter list              01003
CSPLSAVE DS    6F                                                       01004
CPECB    DC    F'0'                fake ECB for this CP                 01005
FLAGWORD DC    F'0'                                                     01006
CSOABLOK DS    2F                                                       01007
CBUF     DC    AL2(37),AL2(0)                                           01008
REPLY    DC    CL33' '             user's command input buffer          01009
ADDRSCAN DS    A                                                        01010
         DROP  R12                                                      01011
         EJECT                                                          01012
*********************************************************************** 01013
*                                                                     * 01014
*                          A T T N E X I T                            * 01015
*                                                                     * 01016
*         Trap userd Attention Interrupts and flag for reset          * 01017
*                                                                     * 01018
*********************************************************************** 01019
ATTNEXIT SAVE  (14,12)            save the callers registers            01020
         LR    R7,R15             establish                             01021
         USING ATTNEXIT,R7        addressability.                       01022
         LA    R11,SAVEA          set-up                                01023
         ST    R13,SAVEA+4         save                                 01024
         ST    R11,8(,R13)          area                                01025
         LR    R13,R11               chaining                           01026
         MVI   ATTNFLG,X'FF'      set attn flag                         01027
         L     R13,SAVEA+4        callers save area pointer.            01028
         RETURN (14,12),RC=0      and away we go...                     01029
SAVEA    DS    18F                                                      01030
         DROP  R7                                                       01031
         EJECT                                                          01032
*********************************************************************** 01033
*                                                                     * 01034
*                             Constants                               * 01035
*                                                                     * 01036
*********************************************************************** 01037
STAXLIST STAX  ATTNEXIT,MF=L                                            01038
PACK     DS    D                                                        01039
WORK     DS    D                                                        01040
SCRATCH  DS    D                  scratch area                          01041
ASCBADDR DS    F                  ASCB addr save area                   01042
FRSTASVT DS    F                  first ASVT entry save area            01043
COUNTER  DC    F'0'               wait counter                          01044
TRANSSEC DS    F                  transaction time in seconds           01045
DELAY    DC    F'100'             2 second delay for refresh            01046
HLP1ADDR DC    A(HELP1)                                                 01047
HLP2ADDR DC    A(HELP2)                                                 01048
ADBUF    DC    A(0)                                                     01049
SCRSIZE  DC    H'0'                                                     01050
ATTNFLG  DC    X'00'              attention flag                        01051
WAITSW   DC    X'00'              wait mode                             01052
MODESW   DC    X'00'              mode change.                          01053
SRMSW    DC    X'00'              SRM mode.                             01054
PTRN1    DC    X'20202020202120'  edit pattern                          01055
PTRN2    DC    X'202021204B202020'                                      01056
PATTERN  DC    X'40202020'        edit pattern                          01057
DPATTRN  DC    X'4021204B20'      edit pattern                          01058
BLANKS   DC    CL40' '                                                  01059
         SPACE 2                                                        01060
CODETABL DC    C'O'  Swap Code 1 : Terminal output wait                 01061
         DC    C'I'  Swap Code 2 : Terminal input wait                  01062
         DC    C'W'  Swap Code 3 : Long Wait                            01063
         DC    C'A'  Swap Code 4 : Auxiliary Storage Shortage           01064
         DC    C'R'  Swap Code 5 : Real Storage Shortage                01065
         DC    C'V'  Swap Code 6 : MS0 Detected Wait                    01066
         DC    C'S'  Swap Code 7 : REQSWAP SYSEVENT Issued              01067
         DC    C'E'  Swap Code 8 : ENQHOLD Exchg by swap analysis       01068
         DC    C'X'  Swap Code 9 : EXCHG Recommended by swap analysis   01069
         DC    C'$'  Swap Code A : Unilateral Swapout                   01070
HEX      DC    C'0123456789ABCDEF'                                      01071
START    DC    C'Starting'                                              01072
         EJECT                                                          01073
*********************************************************************** 01074
*                                                                     * 01075
*                        Format Display Line                          * 01076
*                                                                     * 01077
*********************************************************************** 01078
X        DC    CL80' '                                                  01079
         ORG   X                  Byte                                  01080
LINE     DC    X'1D60'            0     Protected, low intensity        01081
JOB      DC    CL8' '             2                                     01082
         DC    C' '               10                                    01083
         ORG   X+11               For General Listing                   01084
PROCSTEP DC    CL8' '             11                                    01085
         DC    C' '               19                                    01086
STEPNAME DC    CL8' '             20                                    01087
         DC    CL3' '             28                                    01088
ASID     DC    CL2' '             31                                    01089
         DC    CL2' '             33                                    01090
CPU      DC    CL6' '             35                                    01091
         DC    C' '               41                                    01092
         ORG   X+11               For SRM Listing                       01093
$UCBPGN  DC    CL2' '             11                                    01094
         DC    C' '               13                                    01095
$UCBPGP  DC    C' '               14                                    01096
         DC    C' '               15                                    01097
$UCBDOM  DC    CL2' '             16                                    01098
         DC    C' '               18                                    01099
DP       DC    CL2' '             19                                    01100
         DC    C' '               21                                    01101
DQ       DC    CL2' '             22                                    01102
         DC    C' '               24                                    01103
$UCBRMR  DC    CL2' '             25                                    01104
         DC    C' '               27                                    01105
$UCBWMR  DC    CL2' '             28                                    01106
         DC    C' '               30                                    01107
SERATE   DC    CL3' '             31                                    01108
         DC    C' '               34                                    01109
$UCBWMS  DC    CL6' '             35                                    01110
         DC    C' '               41                                    01111
         ORG   X+42               For General and SRM Listings          01112
TCPU     DC    CL6' '             42                                    01113
         DC    C' '               48                                    01114
$UCBSWC  DC    CL2' '             49                                    01115
         DC    C' '               51                                    01116
STATUS   DC    C' '               52                                    01117
         DC    C' '               53                                    01118
LOC      DC    C' '               54                                    01119
         DC    C' '               55                                    01120
MEM      DC    CL3' '             56                                    01121
         DC    C' '               59                                    01122
         ORG   X+60               For SRM listing                       01123
$UCBWSS  DC    CL3' '             60                                    01124
         DC    C' '               63                                    01125
IOC      DC    CL5' '             64                                    01126
         DC    C' '               69                                    01127
TSLS     DC    CL5' '             70                                    01128
         DC    C' '               75                                    01129
         ORG   X+60               For General Listing                   01130
HH       DC    CL2' '             60                                    01131
         DC    C':'               62                                    01132
MM       DC    CL2' '             63                                    01133
         DC    C':'               65                                    01134
SS       DC    CL2' '             66                                    01135
         DC    C' '               68                                    01136
MSL      DC    C' '               69                                    01137
         DC    C' '               70                                    01138
$UXBTRS  DC    CL7' '             71                                    01139
         DC    C' '               78                                    01140
TCBA     DC    CL1' '             79                                    01141
         DC    C' '               80                                    01142
         ORG X+90                                                       01143
FULLSCR  DC    X'03'                                                    01144
EDITFLG  DC    X'00'                                                    01145
CRTFLAG  DC    X'FF'                                                    01146
JOBMASK  DC    CL8'        '                                            01147
ERRMSG1  DC    CL27' ERROR - Non-numeric value '                        01148
ERRMSG2  DC    CL27' ERROR - Invalid command   '                        01149
         LTORG                                                          01150
HEADING1 DC CL80' Jobname  PG P Dm DP DQ RM WR SU/S  S.U.  TCPU  SC R LX01151
                Mem WSS   I/O  TSLS       '                             01152
HEADING2 DC CL80' Jobname  Procstep Stepname  ASID   CPU   TCPU  SC R LX01153
                Mem HH:MM:SS MSL S.U. TCB '                             01154
CLR      DC    X'C1'               WCC - Clear screen at end of pgm     01155
         DC    X'115D7E'           SBA to row 24, col 79 (FSE 5.0)      01156
         DC    X'114040'           SBA to row 1, col 1                  01157
         DC    X'3C404000'         Fill screen with nulls               01158
         DC    X'114040'           SBA to row 1, col 1                  01159
         DC    X'13'               Insert cursor                        01160
CLRLEN   EQU   *-CLR                                                    01161
CLEAR    DC    X'C1'               WCC                                  01162
         DC    X'115D7F'           SBA to row 24, col 80 (FSE 5.0)      01163
         DC    X'114040'           SBA to row 1, col 1                  01164
         DC    X'3C404000'         Fill screen with nulls               01165
PHEADING DC    X'114040'           SBA to row 1, COL 1                  01166
         DC    X'1D40'             ATTR Byte - unprotected, low intens. 01167
         DC    X'13'               Insert cursor                        01168
         DC    C'   '                                                   01169
ERROR    DC    CL30' '                                                  01170
CMDCTRL1 DC    X'1DE8'             ATTR Byte - protected, hi intens.    01171
         DC    CL7'Timer: '                                             01172
TIME     DC    CL3'   '                                                 01173
SLASH    DC    CL1'/'                                                   01174
PAUSE    DC    CL3'1.0'                                                 01175
         DC    CL5'     '                                               01176
         DC    CL6'Mode: '                                              01177
MODETBA  DC    CL1'B'                                                   01178
MODEIO   DC    CL2'O '                                                  01179
MODEGS   DC    CL9'General  '                                           01180
MASKNAME DC    CL7'  Page '                                             01181
PAGE     DC    CL1'1'                                                   01182
HEADINGA DS    CL80' '                                                  01183
BUFFER   DC    41CL81' '                                                01184
LENGTH   EQU   BUFFER-CLEAR                                             01185
         EJECT                                                          01186
HELP1    DC    X'C1'               WCC                                  01187
         DC    X'115D7F'           SBA to row 24, col 80 (FSE 5.0)      01188
         DC    X'114040'           SBA to row 1, col 1                  01189
         DC    X'3C404000'         Fill screen with nulls               01190
         DC    X'114040',X'1DE8',C'Command      Description'            01191
         DC    X'11C150'                                                01192
         DC    X'11C260',C'   A         Display Started tasks, batch '  01193
         DC    C'and TSO'                                               01194
         DC    X'11C3F0',C'   B         Display Started tasks and '     01195
         DC    C'batch only'                                            01196
         DC    X'11C540',C'   DXX       Set delay to XX tenths seconds' 01197
         DC    X'11C650',C'   E         End SWAP'                       01198
         DC    X'11C760',C'   F         Display all Jobnames'           01199
         DC    X'11C8F0',C'   FXXXXXXXX Display only Job ''XXXXXXXX'''  01200
         DC    X'114A40',C'   G         General Information Will be '   01201
         DC    C'displayed'                                             01202
         DC    X'114B50',C'   I         Display only swapped-in '       01203
         DC    C'memories'                                              01204
         DC    X'114C60',C'   O         Display both in and out '       01205
         DC    C'memories'                                              01206
         DC    X'114DF0',C'   L         LINK to program SPY '           01207
         DC    C'(if available)'                                        01208
         DC    X'114F40',C'   S         SRM information displayed'      01209
         DC    X'115050',C'   T         Display TSO jobs only'          01210
         DC    X'11D160',C'   W         Start timer mode for 30 '       01211
         DC    C'seconds'                                               01212
         DC    X'11D2F0',C'   WXX       Start timer mode for XX '       01213
         DC    C'seconds'                                               01214
         DC    X'11D440',C'   W0        Start timer mode until '        01215
         DC    C'interrUPT'                                             01216
         DC    X'11D550',C'   ?         Display this page'              01217
         DC    X'11D660'                                                01218
         DC    X'11D7F0',C'Hitting INTERRUPT will stop the wait timer'  01219
         DC    X'11D940'                                                01220
         DC    X'115A50',C'*WARNING*  INTERRUPT may be ignored if '     01221
         DC    C'timer is set too fast (< .4 sec)'                      01222
         DC    X'115B60'                                                01223
         DC    X'115CF0',C'Hit ENTER to continue'                       01224
         DC    X'115DC61D40134040401DE8'                                01225
HELPMRK1 EQU   *                                                        01226
HELPLEN1 EQU   HELPMRK1-HELP1                                           01227
         EJECT                                                          01228
HELP2    DC    X'C1'               WCC                                  01229
         DC    X'115D7F'           SBA to row 24, col 80 (FSE 5.0)      01230
         DC    X'114040'           SBA to row 1, col 1                  01231
         DC    X'3C404000'         Fill screen with nulls               01232
         DC    X'114040',X'1DE8',C'Swap Code    Description'            01233
         DC    X'11C150'                                                01234
         DC    X'11C260',C'   A       Auxilary storage shortage'        01235
         DC    X'11C260',C'   E       ENQHOLD exchange'                 01236
         DC    X'11C3F0',C'   I       Terminal input wait'              01237
         DC    X'11C540',C'   O       Terminal output wait'             01238
         DC    X'11C650',C'   R       Real storage shortage'            01239
         DC    X'11C760',C'   S       REQSWAP SYSEVENT issued'          01240
         DC    X'11C8F0',C'   V       MS0 detected wait'                01241
         DC    X'114A40',C'   W       Long wait'                        01242
         DC    X'114B50',C'   X       Exchange swap'                    01243
         DC    X'114C60',C'   $       Unilateral swapout'               01244
         DC    X'114DF0',C'   ?       Unknown'                          01245
         DC    X'114F40'                                                01246
         DC    X'115050',C'Loc. Code   Description'                     01247
         DC    X'11D160'                                                01248
         DC    X'11D2F0',C'    I      Swapped in and eligible to run'   01249
         DC    X'11D440',C'    O      Swapped out but ready to run'     01250
         DC    X'11D550',C'    W      Swapped out and not ready to run' 01251
         DC    X'11D660',C'    $      Swapped in: V=R or non-swappable' 01252
         DC    X'11D7F0',C'    ?      In transition between states'     01253
         DC    X'11D940',C'    L      Logically Swapped'                01254
         DC    X'115A50'                                                01255
         DC    X'115B60',C'Version 4.5'                                 01256
         DC    X'115CF0',C'Hit ENTER to continue'                       01257
         DC    X'115DC61D40134040401DE8'                                01258
HELPMRK2 EQU   *                                                        01259
HELPLEN2 EQU   HELPMRK2-HELP2                                           01260
         EJECT                                                          01261
*********************************************************************** 01262
*                                                                     * 01263
*                System Control Block Mapping DSECTs                  * 01264
*                                                                     * 01265
*     All macros can be found in either 'SYS1.MACLIB' or in           * 01266
*     'SYS1.AMODGEN'.                                                 * 01267
*                                                                     * 01268
*********************************************************************** 01269
         PRINT GEN                                                      01270
         CVT   DSECT=YES          Communications Vector Table           01271
         SPACE 2                                                        01272
         IEZJSCB ,                Job Step Control Block                01273
         SPACE 2                                                        01274
         IHAASCB ,                Address Space Control Block           01275
         SPACE 2                                                        01276
         IHAASVT ,                Address Space Vector Table            01277
         SPACE 2                                                        01288
         IRAOUCB ,                SRM User Control Block                01289
         SPACE 2                                                        01278
         IHAOUXB ,                SRM User Extension Block              01279
         SPACE 2                                                        01280
         IKJCSOA ,                Command Scan OuTPUT Area              01281
         SPACE 2                                                        01282
         IKJCSPL ,                Command Scan Parameter List           01283
         SPACE 2                                                        01284
         IKJPSCB ,                Protected Step Control Block          01285
         SPACE 2                                                        01286
         IKJTCB  ,                Task Control Block                    01287
         SPACE 2                                                        01290
         END   SWAP                                                     01291
